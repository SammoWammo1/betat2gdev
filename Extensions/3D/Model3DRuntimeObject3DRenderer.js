var gdjs;(function(s){const r=1/(1<<16),g=i=>{i.metalness&&(i.metalness=0)},b=i=>{const t=i;if(!!t.material)if(Array.isArray(t.material))for(let e=0;e<t.material.length;e++)g(t.material[e]);else g(t.material)},f=i=>i.traverse(b),M=i=>{const t=new THREE.MeshBasicMaterial;return i.color&&(t.color=i.color),i.map&&(t.map=i.map),t},D=i=>{const t=i;if(!!t.material)if(Array.isArray(t.material))for(let e=0;e<t.material.length;e++)t.material[e]=M(t.material[e]);else t.material=M(t.material)},T=i=>i.traverse(D);class j extends s.RuntimeObject3DRenderer{constructor(t,e){const l=e.getGame().getModel3DManager().getModel(t._modelResourceName),a=new THREE.Group,n=new THREE.Group;n.rotation.order="ZYX",n.add(a);super(t,e,n);this._model3DRuntimeObject=t,this._threeObject=a,this._originalModel=l,this._modelOriginPoint=[0,0,0],this.updateSize(),this.updatePosition(),this.updateRotation(),this._animationMixer=new THREE.AnimationMixer(a),this._action=null}updateAnimation(t){this._animationMixer.update(t)}updatePosition(){const t=this.getOriginPoint(),e=this.getCenterPoint();this.get3DRendererObject().position.set(this._object.getX()-this._object.getWidth()*(t[0]-e[0]),this._object.getY()-this._object.getHeight()*(t[1]-e[1]),this._object.getZ()-this._object.getDepth()*(t[2]-e[2]))}getOriginPoint(){return this._model3DRuntimeObject._originPoint||this._modelOriginPoint}getCenterPoint(){return this._model3DRuntimeObject._centerPoint||this._modelOriginPoint}_updateDefaultTransformation(t,e,l,a,n,u,R,m){t.rotation.set(s.toRad(e),s.toRad(l),s.toRad(a)),t.updateMatrixWorld(!0);const o=new THREE.Box3().setFromObject(t);!this._model3DRuntimeObject._originPoint&&o.expandByPoint(new THREE.Vector3(0,0,0));const c=o.max.x-o.min.x,d=o.max.y-o.min.y,h=o.max.z-o.min.z;this._modelOriginPoint[0]=c<r?0:-o.min.x/c,this._modelOriginPoint[1]=d<r?0:-o.min.y/d,this._modelOriginPoint[2]=h<r?0:-o.min.z/h,this._modelOriginPoint[1]=1-this._modelOriginPoint[1];const p=this._model3DRuntimeObject._centerPoint;p&&t.position.set(-(o.min.x+c*p[0]),-(o.min.y+d*(1-p[1])),-(o.min.z+h*p[2])),t.scale.set(1,1,1),t.rotation.set(s.toRad(e),s.toRad(l),s.toRad(a));const P=c<r?1:1/c,A=d<r?1:1/d,H=h<r?1:1/h,O=new THREE.Matrix4;if(O.makeScale(P,-A,H),t.updateMatrix(),t.applyMatrix4(O),m){const x=c<r?Number.POSITIVE_INFINITY:n/c,v=d<r?Number.POSITIVE_INFINITY:u/d,I=h<r?Number.POSITIVE_INFINITY:R/h;let _=Math.min(x,v,I);Number.isFinite(_)||(_=1),this._object._setOriginalWidth(_*c),this._object._setOriginalHeight(_*d),this._object._setOriginalDepth(_*h)}else this._object._setOriginalWidth(n),this._object._setOriginalHeight(u),this._object._setOriginalDepth(R)}_reloadModel(t,e){this._originalModel=e.getGame().getModel3DManager().getModel(t._modelResourceName)}_updateModel(t,e,l,a,n,u,R){const m=new THREE.Group;m.rotation.order="ZYX";const o=THREE_ADDONS.SkeletonUtils.clone(this._originalModel.scene);m.add(o),this._replaceMaterials(m),this._updateDefaultTransformation(m,t,e,l,a,n,u,R),this.get3DRendererObject().remove(this._threeObject),this.get3DRendererObject().add(m),this._threeObject=m,this.updatePosition(),this._updateShadow(),this._animationMixer=new THREE.AnimationMixer(o);const E=this._model3DRuntimeObject.isAnimationPaused();this._model3DRuntimeObject.setAnimationIndex(this._model3DRuntimeObject.getAnimationIndex()),E&&this.pauseAnimation()}_replaceMaterials(t){this._model3DRuntimeObject._materialType===s.Model3DRuntimeObject.MaterialType.StandardWithoutMetalness?f(t):this._model3DRuntimeObject._materialType===s.Model3DRuntimeObject.MaterialType.Basic&&T(t)}getAnimationCount(){return this._originalModel.animations.length}getAnimationName(t){return this._originalModel.animations[t].name}_updateShadow(){this._threeObject.traverse(t=>{t.castShadow=this._model3DRuntimeObject._isCastingShadow,t.receiveShadow=this._model3DRuntimeObject._isReceivingShadow})}hasAnimationEnded(){return this._action?!this._action.isRunning():!0}animationPaused(){if(!!this._action)return this._action.paused}pauseAnimation(){!this._action||(this._action.paused=!0)}resumeAnimation(){!this._action||(this._action.paused=!1)}playAnimation(t,e,l=!1){const a=THREE.AnimationClip.findByName(this._originalModel.animations,t);if(!a){console.error(`The GLB file: ${this._model3DRuntimeObject._modelResourceName} doesn't have any animation named: ${t}`);return}const n=this._action;this._action=this._animationMixer.clipAction(a),this._action.reset(),this._action.setLoop(e?THREE.LoopRepeat:THREE.LoopOnce,Number.POSITIVE_INFINITY),this._action.clampWhenFinished=!0,this._action.timeScale=this._model3DRuntimeObject.getAnimationSpeedScale(),n&&n!==this._action&&!l&&this._action.crossFadeFrom(n,this._model3DRuntimeObject._crossfadeDuration,!1),this._action.play(),this._animationMixer.update(0)}getAnimationElapsedTime(){return this._action?this._action.time:0}setAnimationElapsedTime(t){this._action&&(this._action.time=t)}setAnimationTimeScale(t){this._action&&(this._action.timeScale=t)}getAnimationDuration(t){const e=THREE.AnimationClip.findByName(this._originalModel.animations,t);return e?e.duration:0}}s.Model3DRuntimeObjectRenderer=j})(gdjs||(gdjs={}));
//# sourceMappingURL=Model3DRuntimeObject3DRenderer.js.map
